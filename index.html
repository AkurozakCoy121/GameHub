<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KingzzStore - Jual Akun Game Terbaik</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-900;
        }
        .page-content {
            @apply container mx-auto p-4 md:p-8;
        }
        .product-card {
            @apply bg-white rounded-2xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300 overflow-hidden cursor-pointer;
        }
        .admin-panel {
            @apply flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6;
        }
        .admin-sidebar {
            @apply w-full md:w-64 bg-white rounded-2xl shadow-lg p-4 mb-6 md:mb-0 border border-gray-200;
        }
        .admin-content {
            @apply flex-grow bg-white rounded-2xl shadow-lg p-6 border border-gray-200;
        }
        .input-group label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .input-group input, .input-group select, .input-group textarea {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-900 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition-colors duration-200 shadow-md;
        }
        .btn-danger {
            @apply bg-red-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-700 transition-colors duration-200 shadow-md;
        }
        .badge {
            @apply px-2.5 py-1 rounded-full text-xs font-bold;
        }
        .modal {
            @apply fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50;
        }
        .modal-content {
            @apply bg-white rounded-2xl shadow-xl max-w-lg w-full p-8;
        }
        .nav-link {
            @apply text-gray-700 hover:text-blue-600 transition-colors duration-200 font-medium;
        }
        .sidebar-link {
            @apply flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors;
        }

        /* Perbaikan UI dan menambahkan animasi */
        .card-animate {
            transform: translateY(0);
            transition: transform 0.5s ease-out;
        }
        .card-animate:hover {
            transform: translateY(-5px);
        }
        .pulse-animation {
            animation: pulse-ring 1.5s cubic-bezier(0.2, 0, 0, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .chat-user-item {
            @apply p-3 rounded-lg cursor-pointer transition-colors duration-200;
        }
        .chat-user-item:hover {
            @apply bg-gray-100;
        }
        .chat-user-item.active {
            @apply bg-blue-500 text-white;
        }
        .chat-user-item.active .text-gray-500 {
            @apply text-blue-200;
        }
        .chat-message {
            @apply p-3 rounded-lg shadow-sm;
        }
        .chat-message.self {
            @apply bg-blue-500 text-white self-end rounded-br-none;
        }
        .chat-message.other {
            @apply bg-gray-200 text-gray-800 self-start rounded-bl-none;
        }
    </style>
</head>
<body>

    <!-- Modal Notifikasi Kustom -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close-btn" class="btn-primary">Tutup</button>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Pembayaran -->
    <div id="payment-success-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-green-600 mb-4 text-center">Pembayaran Berhasil!</h3>
            <div id="payment-success-content" class="text-gray-800 text-center space-y-4">
                <p>Selamat! Akun Anda telah berhasil dikirim. Silakan salin teks di bawah ini.</p>
                <div class="bg-gray-100 border border-gray-300 p-4 rounded-lg shadow-inner">
                    <pre id="payment-success-text" class="whitespace-pre-wrap font-mono text-left"></pre>
                </div>
                <button id="copy-account-text-btn" class="btn-primary w-full">Salin Teks Akun</button>
                <button id="payment-success-close-btn" class="btn-secondary w-full">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Ad Banner Modal -->
    <div id="ad-modal" class="modal hidden">
        <div class="modal-content text-center relative">
            <div id="ad-content"></div>
            <button id="ad-close-btn" class="absolute top-4 right-4 text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
        </div>
    </div>

    <!-- Header / Navbar -->
    <nav class="bg-white shadow-md py-4 sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between px-4">
            <div class="flex items-center">
                <a href="#" class="flex items-center space-x-2">
                    <img src="https://iili.io/Kdi9uHl.jpg" alt="KingzStore Logo" class="h-12 w-12 rounded-full border-2 border-blue-500">
                    <span class="text-3xl font-bold text-gray-900">KingzzStore</span>
                </a>
            </div>
            <div class="space-x-4 flex items-center">
                <button id="nav-btn-home" class="nav-link">Beranda</button>
                <button id="nav-btn-products" class="nav-link">Produk</button>
                <button id="nav-btn-chat" class="nav-link">Chat</button>
                <button id="nav-btn-login" class="btn-primary">Login</button>
                <button id="nav-btn-admin" class="btn-secondary hidden">Admin Panel</button>
                <button id="nav-btn-logout" class="btn-danger hidden">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main class="page-content">

        <!-- Home Page -->
        <section id="home-page">
            <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-200">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">Selamat Datang di KingzzStore âœ¨</h1>
                <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto">Tempat terbaik untuk beli akun Steam & Roblox. Murah, aman, dan terpercaya!</p>
                <div class="flex justify-center space-x-4">
                    <button id="home-btn-products" class="btn-primary text-lg">Lihat Produk</button>
                    <button id="home-btn-chat" class="btn-secondary text-lg">Hubungi Kami</button>
                </div>
            </div>
            <div class="mt-8 rounded-2xl overflow-hidden shadow-xl border-4 border-blue-500">
                <img src="https://iili.io/KdiYi0u.jpg" alt="Banner" class="w-full h-auto object-cover">
            </div>
        </section>

        <!-- Product Listing Page -->
        <section id="product-list-page" class="hidden">
            <div class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-4 md:space-y-0">
                <h2 class="text-3xl font-bold">Daftar Produk</h2>
                <div class="flex flex-wrap items-center space-x-2 space-y-2 md:space-y-0">
                    <button id="filter-all" class="btn-secondary">Semua</button>
                    <button id="filter-steam" class="btn-secondary">Steam</button>
                    <button id="filter-roblox" class="btn-secondary">Roblox</button>
                    <input type="text" id="search-input" placeholder="Cari produk..." class="p-3 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Product cards will be injected here by JS -->
            </div>
        </section>

        <!-- Product Detail Page -->
        <section id="product-detail-page" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 border border-gray-200">
                <div class="flex flex-col md:flex-row md:space-x-8">
                    <div id="product-detail-image-container" class="w-full md:w-1/2">
                        <img id="product-detail-image" src="" alt="Gambar Produk" class="rounded-2xl w-full object-cover shadow-md mb-4 border border-gray-200">
                        <div id="product-detail-screenshots" class="grid grid-cols-3 gap-2"></div>
                    </div>
                    <div class="w-full md:w-1/2 mt-6 md:mt-0">
                        <h2 id="product-detail-title" class="text-3xl md:text-4xl font-bold mb-2"></h2>
                        <div class="flex flex-wrap items-center space-x-2 mb-4">
                            <span id="product-detail-platform" class="badge bg-blue-100 text-blue-800"></span>
                            <span id="product-detail-stock" class="badge bg-yellow-100 text-yellow-800"></span>
                        </div>
                        <div class="mb-4">
                            <span id="product-detail-price" class="text-3xl md:text-4xl font-extrabold text-green-600"></span>
                            <span id="product-detail-discount-price" class="text-xl text-gray-500 line-through ml-2"></span>
                            <span id="product-detail-discount-percent" class="badge bg-red-500 text-white ml-2"></span>
                        </div>
                        <p id="product-detail-description" class="text-gray-700 leading-relaxed mb-6"></p>
                        <ul id="product-detail-features" class="list-disc list-inside text-gray-600 mb-6"></ul>
                        <button id="buy-now-btn" class="btn-primary w-full">Beli Sekarang</button>
                        <div class="bg-gray-100 border-l-4 border-gray-500 text-gray-700 p-4 mt-4 rounded-lg" role="alert">
                            <p class="font-bold">Info Pembelian</p>
                            <p>Follow IG kami: <span class="font-semibold">@KingzzStore</span></p>
                            <p>Untuk pembayaran, hubungi WhatsApp: <span class="font-semibold">+62 819-4458-9876</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Login/Register Page -->
        <section id="auth-page" class="hidden flex items-center justify-center min-h-[80vh]">
            <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md border border-gray-200">
                <h2 id="auth-title" class="text-3xl font-bold mb-6 text-center">Login</h2>
                <form id="auth-form">
                    <div class="input-group mb-4">
                        <label for="auth-email">Email</label>
                        <input type="email" id="auth-email" required>
                    </div>
                    <div class="input-group mb-4">
                        <label for="auth-password">Password</label>
                        <input type="password" id="auth-password" required>
                    </div>
                    <div class="flex items-center mb-6">
                        <input type="checkbox" id="auth-remember" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="auth-remember" class="ml-2 block text-sm text-gray-900">Ingat saya</label>
                    </div>
                    <button type="submit" id="auth-submit-btn" class="btn-primary w-full">Login</button>
                </form>
                <p id="auth-switch" class="mt-4 text-center text-sm text-gray-600">
                    Belum punya akun? <a href="#" id="switch-to-register" class="text-blue-600 hover:underline font-semibold">Daftar sekarang</a>
                </p>
            </div>
        </section>

        <!-- Chat Page -->
        <section id="chat-page" class="hidden flex flex-col h-[70vh]">
            <h2 class="text-3xl font-bold mb-4">Pusat Chat</h2>
            <div id="chat-container" class="flex-grow flex flex-col md:flex-row space-y-4 md:space-x-4 md:space-y-0 overflow-hidden">
                <!-- Chat list (for admin) -->
                <div id="chat-list-sidebar" class="w-full md:w-1/4 bg-white rounded-2xl shadow-lg p-4 overflow-y-auto hidden border border-gray-200">
                    <h3 class="text-xl font-bold mb-4">Daftar Chat</h3>
                    <div id="user-list"></div>
                </div>
                <!-- Chat window -->
                <div id="chat-window" class="flex-grow bg-white rounded-2xl shadow-lg flex flex-col overflow-hidden border border-gray-200">
                    <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col space-y-4">
                        <!-- Messages will be injected here -->
                    </div>
                    <form id="chat-form" class="p-4 border-t border-gray-200 flex items-center space-x-2 bg-gray-50">
                        <input type="text" id="chat-input" placeholder="Tulis pesan..." class="flex-grow p-3 border border-gray-300 rounded-lg">
                        <button type="submit" class="btn-primary">Kirim</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Panel -->
        <section id="admin-panel" class="hidden admin-panel">
            <!-- Admin Sidebar -->
            <aside class="admin-sidebar">
                <h3 class="text-2xl font-bold mb-4">Admin Menu</h3>
                <nav class="space-y-2">
                    <button class="w-full text-left sidebar-link" onclick="showAdminPage('dashboard')">
                        <i class="fas fa-chart-line mr-2 text-blue-600"></i> Dashboard
                    </button>
                    <button class="w-full text-left sidebar-link" onclick="showAdminPage('products')">
                        <i class="fas fa-box-open mr-2 text-blue-600"></i> Manajemen Produk
                    </button>
                    <button class="w-full text-left sidebar-link" onclick="showAdminPage('orders')">
                        <i class="fas fa-receipt mr-2 text-blue-600"></i> Manajemen Pesanan
                    </button>
                    <button class="w-full text-left sidebar-link" onclick="showAdminPage('users')">
                        <i class="fas fa-users-cog mr-2 text-blue-600"></i> Manajemen Pengguna
                    </button>
                    <button class="w-full text-left sidebar-link" onclick="showAdminPage('ads')">
                        <i class="fas fa-bullhorn mr-2 text-blue-600"></i> Manajemen Iklan
                    </button>
                    <button class="w-full text-left sidebar-link" onclick="showAdminPage('logs')">
                        <i class="fas fa-clipboard-list mr-2 text-blue-600"></i> Log Aktivitas
                    </button>
                </nav>
            </aside>

            <!-- Admin Content -->
            <div class="admin-content">
                <!-- Admin Dashboard Section -->
                <div id="admin-dashboard-section" class="space-y-6">
                    <h2 class="text-3xl font-bold mb-4">Dashboard Admin</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-100 text-blue-800 p-4 rounded-lg shadow-md border-l-4 border-blue-500">
                            <p class="text-sm">Total Produk</p>
                            <p id="dashboard-product-count" class="text-2xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-gray-200 text-gray-800 p-4 rounded-lg shadow-md border-l-4 border-gray-500">
                            <p class="text-sm">Order Pending</p>
                            <p id="dashboard-pending-orders" class="text-2xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-green-100 text-green-800 p-4 rounded-lg shadow-md border-l-4 border-green-500">
                            <p class="text-sm">Chat Terbaru</p>
                            <p id="dashboard-recent-chats" class="text-2xl font-bold mt-1">0</p>
                        </div>
                    </div>
                </div>

                <!-- Product Management Section -->
                <div id="admin-products-section" class="space-y-6 hidden">
                    <h2 class="text-3xl font-bold mb-4">Manajemen Produk</h2>
                    <button id="add-product-btn" class="btn-primary">Tambah Produk Baru</button>
                    <div id="product-list-admin" class="space-y-4">
                        <!-- Products will be listed here -->
                    </div>
                </div>

                <!-- Order Management Section -->
                <div id="admin-orders-section" class="space-y-6 hidden">
                    <h2 class="text-3xl font-bold mb-4">Manajemen Pesanan</h2>
                    <div id="order-list-admin" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Orders will be listed here -->
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="admin-users-section" class="space-y-6 hidden">
                    <h2 class="text-3xl font-bold mb-4">Manajemen Pengguna</h2>
                    <button id="add-user-btn" class="btn-primary">Tambah Pengguna Baru</button>
                    <div id="user-list-admin" class="space-y-4">
                        <!-- Users will be listed here -->
                    </div>
                </div>
                
                <!-- Ad Management Section -->
                <div id="admin-ads-section" class="space-y-6 hidden">
                    <h2 class="text-3xl font-bold mb-4">Manajemen Iklan</h2>
                    <form id="ads-form" class="space-y-4">
                        <div class="input-group">
                            <label for="ads-type">Tipe Iklan</label>
                            <select id="ads-type">
                                <option value="text">Teks</option>
                                <option value="image">Gambar (URL)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="ads-value">Konten Iklan (URL Gambar atau Teks)</label>
                            <input type="text" id="ads-value" placeholder="Masukkan URL gambar atau teks iklan">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="ads-active">
                            <label for="ads-active">Aktifkan Iklan?</label>
                        </div>
                        <button type="submit" class="btn-primary mt-4">Simpan Iklan</button>
                    </form>
                </div>

                <!-- Log Management Section -->
                <div id="admin-logs-section" class="space-y-6 hidden">
                    <h2 class="text-3xl font-bold mb-4">Log Aktivitas</h2>
                    <div id="logs-container" class="space-y-2">
                        <!-- Logs will be injected here -->
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Modal Add/Edit Product -->
    <div id="product-form-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="product-form-title" class="text-2xl font-bold mb-4">Tambah Produk</h3>
            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                <div class="input-group">
                    <label>Judul</label>
                    <input type="text" id="product-title" placeholder="Nama produk, misal: Akun Roblox OP" required>
                </div>
                <div class="input-group">
                    <label>Platform</label>
                    <select id="product-platform" required>
                        <option value="Steam">Steam</option>
                        <option value="Roblox">Roblox</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Harga (IDR)</label>
                    <input type="number" id="product-price" placeholder="Harga produk, misal: 50000" required>
                </div>
                <div class="input-group">
                    <label>Diskon (%)</label>
                    <input type="number" id="product-discount" value="0" placeholder="Masukkan angka 0-100">
                </div>
                <div class="input-group">
                    <label>Stok Produk</label>
                    <input type="number" id="product-stock" value="1" min="0" required>
                </div>
                <div class="input-group">
                    <label>Deskripsi</label>
                    <textarea id="product-description" rows="3" placeholder="Deskripsi singkat produk"></textarea>
                </div>
                <div class="input-group">
                    <label>URL Gambar</label>
                    <input type="text" id="product-image-url" placeholder="URL gambar produk">
                </div>
                <div class="input-group">
                    <label>Teks Akun (untuk dikirim)</label>
                    <textarea id="product-account-text" rows="5" placeholder="Detail akun yang akan dikirim ke pembeli, misal: Username: user123, Password: pass456" required></textarea>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="product-visible">
                    <label for="product-visible">Tampilkan di website?</label>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="product-form-cancel" class="btn-secondary">Batal</button>
                    <button type="submit" class="btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal Add User -->
    <div id="add-user-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">Tambah Pengguna Baru</h3>
            <form id="add-user-form" class="space-y-4">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="add-user-email" placeholder="contoh@email.com" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="add-user-password" required>
                </div>
                <div class="input-group">
                    <label>Peran</label>
                    <select id="add-user-role">
                        <option value="user">Pengguna Biasa</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="add-user-cancel" class="btn-secondary">Batal</button>
                    <button type="submit" class="btn-primary">Tambah</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase JS SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAlGXpZSyQab7riDteV5ppS3DXDJQHywKw",
            authDomain: "modmanagerpro-248f5.firebaseapp.com",
            projectId: "modmanagerpro-248f5",
            storageBucket: "modmanagerpro-248f5.firebasestorage.app",
            messagingSenderId: "594650288669",
            appId: "1:594650288669:web:9d19cb5ebed778b6f1ecf4",
            measurementId: "G-XM4V5F6PQC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for UI elements and state
        const pages = ['home-page', 'product-list-page', 'product-detail-page', 'auth-page', 'chat-page', 'admin-panel'];
        const navBtns = {
            home: document.getElementById('nav-btn-home'),
            products: document.getElementById('nav-btn-products'),
            chat: document.getElementById('nav-btn-chat'),
            login: document.getElementById('nav-btn-login'),
            admin: document.getElementById('nav-btn-admin'),
            logout: document.getElementById('nav-btn-logout')
        };
        let currentUser = null;
        let isAdmin = false;

        const adminSections = {
            dashboard: document.getElementById('admin-dashboard-section'),
            products: document.getElementById('admin-products-section'),
            orders: document.getElementById('admin-orders-section'),
            users: document.getElementById('admin-users-section'),
            ads: document.getElementById('admin-ads-section'),
            logs: document.getElementById('admin-logs-section'),
        };

        let currentActiveChat = null;
        let unsubscribeChat = null;

        // --- Perbaikan Fungsionalitas ---

        // Fungsi untuk menampilkan modal notifikasi kustom
        function showCustomModal(title, message, callback = null) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            modal.classList.remove('hidden');

            const closeBtn = document.getElementById('modal-close-btn');
            closeBtn.onclick = () => {
                modal.classList.add('hidden');
                if (callback) callback();
            };
        }
        
        // Fungsi untuk menampilkan modal pembayaran berhasil
        function showPaymentSuccessModal(accountText) {
            const modal = document.getElementById('payment-success-modal');
            document.getElementById('payment-success-text').innerText = accountText;
            modal.classList.remove('hidden');

            const closeBtn = document.getElementById('payment-success-close-btn');
            closeBtn.onclick = () => {
                modal.classList.add('hidden');
                history.replaceState(null, '', location.pathname); // Menghapus parameter dari URL
            };

            const copyBtn = document.getElementById('copy-account-text-btn');
            copyBtn.onclick = () => {
                const textToCopy = document.getElementById('payment-success-text').innerText;
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showCustomModal('Berhasil!', 'Teks akun berhasil disalin ke clipboard.');
                } catch (err) {
                    showCustomModal('Gagal!', 'Gagal menyalin teks. Silakan salin manual.');
                }
                document.body.removeChild(textarea);
            };
        }

        // Fungsi untuk menavigasi antar halaman
        function showPage(pageId) {
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (page) {
                    page.classList.add('hidden');
                }
            });
            const currentPage = document.getElementById(pageId);
            if (currentPage) {
                currentPage.classList.remove('hidden');
            }
            // Logic khusus untuk chat page
            if (pageId === 'chat-page' && isAdmin) {
                document.getElementById('chat-list-sidebar').classList.remove('hidden');
            } else if (pageId === 'chat-page' && !isAdmin) {
                document.getElementById('chat-list-sidebar').classList.add('hidden');
                currentActiveChat = null;
                if (unsubscribeChat) {
                    unsubscribeChat();
                }
                loadUserChat(currentUser.uid);
            }
        }

        function showAdminPage(sectionId) {
            Object.keys(adminSections).forEach(id => {
                adminSections[id].classList.add('hidden');
            });
            adminSections[sectionId].classList.remove('hidden');
        }

        // Fungsi untuk memuat data produk dari Firestore
        async function loadProducts() {
            try {
                const productsCol = collection(db, 'products');
                const productsSnapshot = await getDocs(productsCol);
                const productsContainer = document.getElementById('products-container');
                productsContainer.innerHTML = '';
                productsSnapshot.forEach(doc => {
                    const product = doc.data();
                    if (product.visible && product.stock > 0) {
                        const discountPrice = product.discount > 0 ? (product.price - (product.price * product.discount / 100)).toFixed(0) : null;
                        productsContainer.innerHTML += `
                            <div class="product-card card-animate" onclick="showProductDetail('${doc.id}')">
                                <div class="relative overflow-hidden">
                                    <img src="${product.imageUrl || 'https://placehold.co/400x300/a8a8a8/white?text=No+Image'}" alt="${product.title}" class="w-full h-48 object-cover rounded-t-2xl">
                                    <div class="absolute top-2 right-2 px-2 py-1 rounded-full text-white text-xs font-bold ${product.stock > 0 ? 'bg-green-500' : 'bg-red-500'}">
                                        ${product.stock > 0 ? 'Stok: ' + product.stock : 'Stok Habis'}
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-gray-500">${product.platform}</span>
                                        ${product.discount > 0 ? `<span class="badge bg-red-500 text-white">${product.discount}% OFF</span>` : ''}
                                    </div>
                                    <h3 class="text-lg font-semibold truncate mb-1">${product.title}</h3>
                                    <div class="flex items-baseline space-x-2">
                                        <span class="text-xl font-bold text-green-600">IDR ${discountPrice || product.price.toLocaleString('id-ID')}</span>
                                        ${discountPrice ? `<span class="text-sm text-gray-500 line-through">IDR ${product.price.toLocaleString('id-ID')}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Menambahkan listener untuk pencarian dan filter
                document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const platform = btn.id.split('-')[1];
                        document.getElementById('products-container').innerHTML = '';
                        let q;
                        if (platform === 'all') {
                            q = productsCol;
                        } else {
                            q = query(productsCol, where('platform', '==', platform.charAt(0).toUpperCase() + platform.slice(1)));
                        }
                        const filteredSnapshot = await getDocs(q);
                        filteredSnapshot.forEach(doc => {
                            const product = doc.data();
                            if (product.visible && product.stock > 0) {
                                // Render produk...
                                const discountPrice = product.discount > 0 ? (product.price - (product.price * product.discount / 100)).toFixed(0) : null;
                                productsContainer.innerHTML += `
                                    <div class="product-card card-animate" onclick="showProductDetail('${doc.id}')">
                                        <div class="relative overflow-hidden">
                                            <img src="${product.imageUrl || 'https://placehold.co/400x300/a8a8a8/white?text=No+Image'}" alt="${product.title}" class="w-full h-48 object-cover rounded-t-2xl">
                                            <div class="absolute top-2 right-2 px-2 py-1 rounded-full text-white text-xs font-bold ${product.stock > 0 ? 'bg-green-500' : 'bg-red-500'}">
                                                ${product.stock > 0 ? 'Stok: ' + product.stock : 'Stok Habis'}
                                            </div>
                                        </div>
                                        <div class="p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-sm text-gray-500">${product.platform}</span>
                                                ${product.discount > 0 ? `<span class="badge bg-red-500 text-white">${product.discount}% OFF</span>` : ''}
                                            </div>
                                            <h3 class="text-lg font-semibold truncate mb-1">${product.title}</h3>
                                            <div class="flex items-baseline space-x-2">
                                                <span class="text-xl font-bold text-green-600">IDR ${discountPrice || product.price.toLocaleString('id-ID')}</span>
                                                ${discountPrice ? `<span class="text-sm text-gray-500 line-through">IDR ${product.price.toLocaleString('id-ID')}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    });
                });
                document.getElementById('search-input').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const cards = productsContainer.querySelectorAll('.product-card');
                    cards.forEach(card => {
                        const title = card.querySelector('h3').innerText.toLowerCase();
                        if (title.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });

            } catch (e) {
                console.error("Error loading products: ", e);
            }
        }

        async function showProductDetail(productId) {
            try {
                const productRef = doc(db, 'products', productId);
                const productSnap = await getDoc(productRef);
                if (productSnap.exists()) {
                    const product = productSnap.data();
                    const productDetailImage = document.getElementById('product-detail-image');
                    const productDetailTitle = document.getElementById('product-detail-title');
                    const productDetailPlatform = document.getElementById('product-detail-platform');
                    const productDetailStock = document.getElementById('product-detail-stock');
                    const productDetailPrice = document.getElementById('product-detail-price');
                    const productDetailDiscountPrice = document.getElementById('product-detail-discount-price');
                    const productDetailDiscountPercent = document.getElementById('product-detail-discount-percent');
                    const productDetailDescription = document.getElementById('product-detail-description');
                    const productDetailFeatures = document.getElementById('product-detail-features');
                    const buyNowBtn = document.getElementById('buy-now-btn');

                    const discountPrice = product.discount > 0 ? (product.price - (product.price * product.discount / 100)) : null;

                    productDetailImage.src = product.imageUrl || 'https://placehold.co/600x400/a8a8a8/white?text=No+Image';
                    productDetailTitle.innerText = product.title;
                    productDetailPlatform.innerText = product.platform;
                    productDetailStock.innerText = `Stok: ${product.stock}`;
                    productDetailPrice.innerText = `IDR ${discountPrice ? discountPrice.toLocaleString('id-ID') : product.price.toLocaleString('id-ID')}`;
                    
                    if (discountPrice) {
                        productDetailDiscountPrice.innerText = `IDR ${product.price.toLocaleString('id-ID')}`;
                        productDetailDiscountPrice.classList.remove('hidden');
                        productDetailDiscountPercent.innerText = `${product.discount}% OFF`;
                        productDetailDiscountPercent.classList.remove('hidden');
                    } else {
                        productDetailDiscountPrice.classList.add('hidden');
                        productDetailDiscountPercent.classList.add('hidden');
                    }
                    
                    productDetailDescription.innerText = product.description;

                    productDetailFeatures.innerHTML = '';
                    if (product.features && product.features.length > 0) {
                        product.features.forEach(feature => {
                            const li = document.createElement('li');
                            li.innerText = feature;
                            productDetailFeatures.appendChild(li);
                        });
                    }
                    
                    buyNowBtn.onclick = () => {
                        if (currentUser) {
                            if (product.stock > 0) {
                                // Logika untuk membuat pesanan dan mengurangi stok
                                showCustomModal('Konfirmasi Pembelian', `Apakah Anda yakin ingin membeli ${product.title} seharga IDR ${discountPrice ? discountPrice.toLocaleString('id-ID') : product.price.toLocaleString('id-ID')}?`, async () => {
                                    try {
                                        const ordersCol = collection(db, 'orders');
                                        await addDoc(ordersCol, {
                                            productId: productId,
                                            productTitle: product.title,
                                            buyerId: currentUser.uid,
                                            buyerEmail: currentUser.email,
                                            status: 'pending',
                                            accountText: product.accountText, // Menyimpan teks akun di pesanan
                                            timestamp: serverTimestamp()
                                        });

                                        // Mengurangi stok produk
                                        const newStock = product.stock - 1;
                                        await updateDoc(productRef, { stock: newStock });
                                        
                                        // Arahkan ke WhatsApp dengan teks akun
                                        const whatsappNumber = "6281944589876";
                                        const message = `Halo KingzzStore, saya sudah order akun ${product.title}. Mohon bantuannya untuk pembayaran dan pengiriman akun. Terima kasih.`;
                                        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                                        window.open(whatsappUrl, '_blank');

                                        // Setelah pembayaran selesai (simulasi), kirimkan akun secara otomatis
                                        // Ini adalah simulasi. Dalam aplikasi nyata, ini akan dipicu oleh konfirmasi pembayaran.
                                        setTimeout(async () => {
                                            await deliverAccountText(ordersCol, currentUser.uid, product.accountText);
                                        }, 5000); // Simulasi 5 detik setelah order

                                        showCustomModal('Pesanan Berhasil', 'Pesanan Anda telah dibuat! Silakan lanjutkan pembayaran di WhatsApp.');

                                        // Setelah berhasil, arahkan ke halaman produk dan tampilkan popup
                                        history.pushState({ accountText: product.accountText }, '', '?payment_success=true');
                                        showPage('product-list-page');

                                    } catch (e) {
                                        console.error("Error creating order: ", e);
                                        showCustomModal('Gagal!', 'Terjadi kesalahan saat membuat pesanan.');
                                    }
                                });
                            } else {
                                showCustomModal('Stok Habis!', 'Maaf, stok produk ini sudah habis.');
                            }
                        } else {
                            showCustomModal('Harap Login', 'Anda harus login untuk melakukan pembelian.');
                        }
                    };

                    showPage('product-detail-page');
                } else {
                    showCustomModal('Produk Tidak Ditemukan', 'Produk yang Anda cari tidak ada.');
                }
            } catch (e) {
                console.error("Error showing product detail: ", e);
                showCustomModal('Gagal!', 'Terjadi kesalahan saat menampilkan detail produk.');
            }
        }

        // Fungsi untuk mengirimkan teks akun secara otomatis
        async function deliverAccountText(ordersColRef, userId, accountText) {
            try {
                // Temukan order yang relevan (contoh: status 'pending' untuk user ini)
                const q = query(ordersColRef, where("buyerId", "==", userId), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const orderDoc = querySnapshot.docs[0];
                    const orderRef = doc(db, 'orders', orderDoc.id);

                    // Kirimkan teks akun ke chat user
                    const chatRef = collection(db, 'chats', userId, 'messages');
                    await addDoc(chatRef, {
                        text: `Selamat! Pembayaran berhasil. Akun Anda:\n${accountText}`,
                        senderId: 'admin',
                        timestamp: serverTimestamp()
                    });

                    // Perbarui status pesanan menjadi 'completed'
                    await updateDoc(orderRef, { status: 'completed' });
                }
            } catch (e) {
                console.error("Error delivering account text: ", e);
            }
        }

        // --- Perbaikan Bug Admin dan Chat ---

        // Fungsi untuk memuat chat pengguna
        function loadUserChat(userId) {
            const messagesContainer = document.getElementById('chat-messages');
            if (unsubscribeChat) {
                unsubscribeChat();
            }

            const q = query(collection(db, 'chats', userId, 'messages'), orderBy('timestamp'));
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const isSelf = message.senderId === currentUser.uid;
                    const messageClass = isSelf ? 'self' : 'other';
                    messagesContainer.innerHTML += `
                        <div class="chat-message ${messageClass}">
                            <p>${message.text}</p>
                            <span class="text-xs text-gray-500 mt-1 block text-right">${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString() : ''}</span>
                        </div>
                    `;
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
            currentActiveChat = userId;
        }

        // Fungsi untuk memuat daftar chat admin
        async function loadAdminChats() {
            const userListDiv = document.getElementById('user-list');
            userListDiv.innerHTML = '';
            const chatsCol = collection(db, 'chats');
            const chatsSnapshot = await getDocs(chatsCol);
            chatsSnapshot.forEach(doc => {
                const userId = doc.id;
                const userEmail = doc.data().email || 'User'; // Asumsi email disimpan di dokumen chat
                
                const userItem = document.createElement('div');
                userItem.className = 'chat-user-item';
                userItem.innerHTML = `<p class="font-semibold">${userEmail}</p><span class="text-xs text-gray-500">ID: ${userId.substring(0, 8)}...</span>`;
                userItem.onclick = () => {
                    document.querySelectorAll('.chat-user-item').forEach(el => el.classList.remove('active'));
                    userItem.classList.add('active');
                    loadUserChat(userId);
                };
                userListDiv.appendChild(userItem);
            });
        }
        
        // Menangani pengiriman pesan
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text === '') return;

            if (!currentUser) {
                showCustomModal('Gagal!', 'Anda harus login untuk mengirim pesan.');
                return;
            }
            
            // Tentukan receiver ID
            let recipientId = currentActiveChat || 'admin';
            if (isAdmin && currentActiveChat) {
                // Admin mengirim pesan ke user yang sedang aktif
                recipientId = currentActiveChat;
            } else if (!isAdmin) {
                // User mengirim pesan ke admin
                recipientId = 'admin'; // Admin's user ID is 'admin'
            } else {
                 showCustomModal('Gagal!', 'Pilih pengguna yang ingin Anda kirim pesan.');
                 return;
            }
            
            try {
                const chatDocRef = doc(db, 'chats', recipientId);
                const chatDocSnap = await getDoc(chatDocRef);
                if (!chatDocSnap.exists()) {
                    await setDoc(chatDocRef, { email: recipientId });
                }

                const chatRef = collection(db, 'chats', recipientId, 'messages');
                await addDoc(chatRef, {
                    text: text,
                    senderId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                input.value = '';
            } catch (e) {
                console.error("Error sending message: ", e);
                showCustomModal('Gagal!', 'Terjadi kesalahan saat mengirim pesan.');
            }
        });

        // --- Fungsionalitas Login, Register, Logout ---

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const authTitle = document.getElementById('auth-title').innerText;

            try {
                if (authTitle === 'Login') {
                    await setPersistence(auth, browserSessionPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                    showCustomModal('Login Berhasil', 'Selamat datang kembali!');
                    showPage('home-page');
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userRef = doc(db, 'users', userCredential.user.uid);
                    await setDoc(userRef, {
                        email: userCredential.user.email,
                        role: 'user',
                        createdAt: serverTimestamp()
                    });
                    showCustomModal('Pendaftaran Berhasil', 'Akun Anda berhasil dibuat. Silakan login.');
                    document.getElementById('auth-title').innerText = 'Login';
                    document.getElementById('auth-submit-btn').innerText = 'Login';
                    document.getElementById('auth-switch').innerHTML = `Belum punya akun? <a href="#" id="switch-to-register" class="text-blue-600 hover:underline font-semibold">Daftar sekarang</a>`;
                }
            } catch (error) {
                console.error("Authentication Error: ", error);
                showCustomModal('Gagal!', error.message);
            }
        });

        // --- On Auth State Changed ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                navBtns.login.classList.add('hidden');
                navBtns.logout.classList.remove('hidden');
                // Perbaikan bug admin: Cek peran dari Firestore
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.role === 'admin') {
                            isAdmin = true;
                            navBtns.admin.classList.remove('hidden');
                            // Panggil semua fungsi admin di sini setelah peran dikonfirmasi
                            loadAdminChats();
                            loadAdminStats();
                            loadAdminProducts();
                            loadAdminOrders();
                            loadAdminUsers();
                        } else {
                            isAdmin = false;
                            navBtns.admin.classList.add('hidden');
                        }
                    } else {
                       isAdmin = false;
                       navBtns.admin.classList.add('hidden');
                    }
                } catch (e) {
                    console.error("Error getting user role:", e);
                    isAdmin = false;
                    navBtns.admin.classList.add('hidden');
                }
            } else {
                currentUser = null;
                isAdmin = false;
                navBtns.login.classList.remove('hidden');
                navBtns.logout.classList.add('hidden');
                navBtns.admin.classList.add('hidden');
                if (unsubscribeChat) {
                    unsubscribeChat();
                }
            }
            // Tangani pop-up pembayaran berhasil saat restart
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('payment_success') === 'true') {
                const accountText = history.state?.accountText;
                if (accountText) {
                    showPaymentSuccessModal(accountText);
                }
            }
        });

        // --- Event Listeners UI ---

        navBtns.home.addEventListener('click', () => showPage('home-page'));
        document.getElementById('home-btn-products').addEventListener('click', () => showPage('product-list-page'));
        navBtns.products.addEventListener('click', () => showPage('product-list-page'));
        document.getElementById('home-btn-chat').addEventListener('click', () => {
            if (currentUser) {
                showPage('chat-page');
            } else {
                showCustomModal('Harap Login', 'Anda harus login untuk mengakses fitur chat.');
                showPage('auth-page');
            }
        });
        navBtns.chat.addEventListener('click', () => {
            if (currentUser) {
                showPage('chat-page');
            } else {
                showCustomModal('Harap Login', 'Anda harus login untuk mengakses fitur chat.');
                showPage('auth-page');
            }
        });
        navBtns.login.addEventListener('click', () => showPage('auth-page'));
        navBtns.logout.addEventListener('click', async () => {
            await signOut(auth);
            showCustomModal('Logout Berhasil', 'Anda telah keluar dari akun.');
            showPage('home-page');
        });
        navBtns.admin.addEventListener('click', () => showPage('admin-panel'));

        document.getElementById('switch-to-register').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('auth-title').innerText = 'Daftar';
            document.getElementById('auth-submit-btn').innerText = 'Daftar';
            document.getElementById('auth-switch').innerHTML = `Sudah punya akun? <a href="#" id="switch-to-login" class="text-blue-600 hover:underline font-semibold">Login sekarang</a>`;
            document.getElementById('switch-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('auth-title').innerText = 'Login';
                document.getElementById('auth-submit-btn').innerText = 'Login';
                document.getElementById('auth-switch').innerHTML = `Belum punya akun? <a href="#" id="switch-to-register" class="text-blue-600 hover:underline font-semibold">Daftar sekarang</a>`;
                document.getElementById('switch-to-register').addEventListener('click', (e) => {
                     e.preventDefault();
                     document.getElementById('auth-title').innerText = 'Daftar';
                     document.getElementById('auth-submit-btn').innerText = 'Daftar';
                     document.getElementById('auth-switch').innerHTML = `Sudah punya akun? <a href="#" id="switch-to-login" class="text-blue-600 hover:underline font-semibold">Login sekarang</a>`;
                });
            });
        });

        // --- Admin Panel Functions (diperbaiki dan diorganisir) ---

        let currentProductId = null;
        const productFormModal = document.getElementById('product-form-modal');
        const productForm = document.getElementById('product-form');
        const productFormTitle = document.getElementById('product-form-title');
        const addProductBtn = document.getElementById('add-product-btn');
        const productFormCancelBtn = document.getElementById('product-form-cancel');

        addProductBtn.addEventListener('click', () => {
            productFormTitle.innerText = 'Tambah Produk';
            productForm.reset();
            currentProductId = null;
            productFormModal.classList.remove('hidden');
        });

        productFormCancelBtn.addEventListener('click', () => {
            productFormModal.classList.add('hidden');
        });

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productData = {
                title: document.getElementById('product-title').value,
                platform: document.getElementById('product-platform').value,
                price: parseFloat(document.getElementById('product-price').value),
                discount: parseFloat(document.getElementById('product-discount').value) || 0,
                stock: parseInt(document.getElementById('product-stock').value),
                description: document.getElementById('product-description').value,
                imageUrl: document.getElementById('product-image-url').value,
                accountText: document.getElementById('product-account-text').value,
                visible: document.getElementById('product-visible').checked,
            };
            try {
                if (currentProductId) {
                    await updateDoc(doc(db, 'products', currentProductId), productData);
                    showCustomModal('Berhasil!', 'Produk berhasil diperbarui.');
                } else {
                    await addDoc(collection(db, 'products'), productData);
                    showCustomModal('Berhasil!', 'Produk berhasil ditambahkan.');
                }
                productFormModal.classList.add('hidden');
                loadAdminProducts();
                loadProducts();
            } catch (e) {
                console.error("Error saving product: ", e);
                showCustomModal('Gagal!', 'Terjadi kesalahan saat menyimpan produk.');
            }
        });

        async function loadAdminProducts() {
            const productListAdmin = document.getElementById('product-list-admin');
            productListAdmin.innerHTML = '';
            const q = query(collection(db, 'products'));
            const productsSnapshot = await getDocs(q);
            productsSnapshot.forEach(doc => {
                const product = doc.data();
                productListAdmin.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between border border-gray-200">
                        <div>
                            <p class="font-semibold">${product.title}</p>
                            <p class="text-sm text-gray-600">ID: ${doc.id}</p>
                            <p class="text-sm text-gray-600">Stok: ${product.stock}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn-secondary text-sm" onclick="editProduct('${doc.id}')">Edit</button>
                            <button class="btn-danger text-sm" onclick="deleteProduct('${doc.id}')">Hapus</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('dashboard-product-count').innerText = productsSnapshot.size;
        }

        async function editProduct(id) {
            const productRef = doc(db, 'products', id);
            const productSnap = await getDoc(productRef);
            if (productSnap.exists()) {
                const product = productSnap.data();
                document.getElementById('product-form-title').innerText = 'Edit Produk';
                document.getElementById('product-id').value = id;
                document.getElementById('product-title').value = product.title;
                document.getElementById('product-platform').value = product.platform;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-discount').value = product.discount;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-image-url').value = product.imageUrl;
                document.getElementById('product-account-text').value = product.accountText;
                document.getElementById('product-visible').checked = product.visible;
                currentProductId = id;
                productFormModal.classList.remove('hidden');
            }
        }
        
        async function deleteProduct(id) {
            showCustomModal('Konfirmasi', 'Apakah Anda yakin ingin menghapus produk ini?', async () => {
                try {
                    await deleteDoc(doc(db, 'products', id));
                    showCustomModal('Berhasil!', 'Produk berhasil dihapus.');
                    loadAdminProducts();
                    loadProducts();
                } catch (e) {
                    console.error("Error deleting product: ", e);
                    showCustomModal('Gagal!', 'Terjadi kesalahan saat menghapus produk.');
                }
            });
        }

        async function loadAdminOrders() {
            const orderListAdmin = document.getElementById('order-list-admin');
            orderListAdmin.innerHTML = '';
            const ordersCol = collection(db, 'orders');
            const q = query(ordersCol, where('status', '==', 'pending'));
            const ordersSnapshot = await getDocs(q);
            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                const timestamp = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';
                orderListAdmin.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="font-semibold">Produk: ${order.productTitle}</p>
                        <p class="text-sm text-gray-600">Pembeli: ${order.buyerEmail}</p>
                        <p class="text-sm text-gray-600">Status: <span class="badge bg-yellow-400 text-yellow-900">${order.status}</span></p>
                        <p class="text-xs text-gray-500 mt-2">ID: ${doc.id.substring(0, 8)}...</p>
                        <p class="text-xs text-gray-500">Tanggal: ${timestamp}</p>
                    </div>
                `;
            });
            document.getElementById('dashboard-pending-orders').innerText = ordersSnapshot.size;
        }

        async function loadAdminUsers() {
            const userListAdmin = document.getElementById('user-list-admin');
            userListAdmin.innerHTML = '';
            const usersCol = collection(db, 'users');
            const usersSnapshot = await getDocs(usersCol);
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                userListAdmin.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between border border-gray-200">
                        <div>
                            <p class="font-semibold">${user.email}</p>
                            <p class="text-sm text-gray-600">ID: ${doc.id.substring(0, 8)}...</p>
                            <p class="text-sm text-gray-600">Peran: ${user.role}</p>
                        </div>
                        <div class="flex space-x-2">
                             <button class="btn-danger text-sm" onclick="deleteUser('${doc.id}')">Hapus</button>
                        </div>
                    </div>
                `;
            });
        }
        
        async function addUser(email, password, role) {
            try {
                // Buat user di Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Simpan peran user di Firestore
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, { email: user.email, role: role, createdAt: serverTimestamp() });
                showCustomModal('Berhasil!', `Pengguna ${user.email} berhasil ditambahkan sebagai ${role}.`);
                loadAdminUsers();
            } catch (e) {
                console.error("Error adding user: ", e);
                showCustomModal('Gagal!', e.message);
            }
        }
        
        document.getElementById('add-user-btn').addEventListener('click', () => {
             document.getElementById('add-user-modal').classList.remove('hidden');
        });
        document.getElementById('add-user-cancel').addEventListener('click', () => {
             document.getElementById('add-user-modal').classList.add('hidden');
        });
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('add-user-email').value;
            const password = document.getElementById('add-user-password').value;
            const role = document.getElementById('add-user-role').value;
            await addUser(email, password, role);
            document.getElementById('add-user-modal').classList.add('hidden');
        });

        // Expose functions for buttons
        window.showAdminPage = showAdminPage;
        window.showProductDetail = showProductDetail;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.deleteUser = deleteUser;

        // Inisialisasi
        window.onload = () => {
            showPage('home-page');
            loadProducts();
        };

        async function deleteUser(id) {
            showCustomModal('Konfirmasi', 'Apakah Anda yakin ingin menghapus pengguna ini? Tindakan ini tidak dapat dibatalkan.', async () => {
                try {
                    // Hapus user dari Firestore (tidak bisa menghapus dari Auth dengan cara ini)
                    await deleteDoc(doc(db, 'users', id));
                    showCustomModal('Berhasil!', 'Pengguna berhasil dihapus.');
                    loadAdminUsers();
                } catch (e) {
                    console.error("Error deleting user: ", e);
                    showCustomModal('Gagal!', 'Terjadi kesalahan saat menghapus pengguna.');
                }
            });
        }

        async function loadAdminStats() {
            try {
                const productsSnapshot = await getDocs(collection(db, 'products'));
                document.getElementById('dashboard-product-count').innerText = productsSnapshot.size;

                const pendingOrdersQuery = query(collection(db, 'orders'), where('status', '==', 'pending'));
                const pendingOrdersSnapshot = await getDocs(pendingOrdersQuery);
                document.getElementById('dashboard-pending-orders').innerText = pendingOrdersSnapshot.size;

                // Load chat stats
                const chatsCol = collection(db, 'chats');
                const chatsSnapshot = await getDocs(chatsCol);
                document.getElementById('dashboard-recent-chats').innerText = chatsSnapshot.size;
            } catch (e) {
                console.error("Error loading admin stats: ", e);
            }
        }
    </script>
</body>
</html>
